---

- name: update domserver code
  hosts: domserver
  vars:
    host_type: domserver
  become: yes
  handlers:
    - include: handlers.yml
  roles:
    - role: domjudge_checkout
      tags: domjudge_checkout
  tasks:

    - name: run maintainer-conf
      become: yes
      become_user: domjudge
      command: make maintainer-conf CONFIGURE_FLAGS='--disable-doc-build'
      register: dj_configured
      args:
        chdir: "{{DJ_DIR}}"
        creates: "{{DJ_DIR}}/paths.mk"

    - name: install dbpasswords.secret file
      template: src=files/dbpasswords.secret.j2 dest="{{DJ_DIR}}/etc/dbpasswords.secret"

    - name: check if domjudge is built
      stat: path="{{DJ_DIR}}/judge/judgedaemon"
      register: judgedaemon_binary

    - name: build domjudge
      become: yes
      become_user: domjudge
      shell: make maintainer-install chdir={{DJ_DIR}}
      when: git_working_copy.changed or dj_configured.changed or not judgedaemon_binary.stat.exists

    - name: fix permissions on things
      shell: make -C {{DJ_DIR}} maintainer-postinstall-permissions
