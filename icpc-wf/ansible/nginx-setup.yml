# Tasks to set up the nginx configuration
---
    - name: copy domjudge FPM conf
      copy:
        remote_src: true
        src: "{{DJ_DIR}}/etc/domjudge-fpm.conf"
        dest: /etc/php/7.4/fpm/pool.d/domjudge.conf
      notify: restart PHP FPM

    - name: add domjudge nginx conf
      template:
        src: files/nginx-domjudge.conf.j2
        dest: /etc/nginx/sites-available/domjudge.conf
      notify: restart nginx

    - name: add domjudge inner nginx conf
      template:
        src: files/nginx-domjudge-inner.j2
        dest: /etc/nginx/snippets/domjudge-inner
      notify: restart nginx

    - name: enable nginx conf for domjudge
      file:
        src: /etc/nginx/sites-available/domjudge.conf
        dest: /etc/nginx/sites-enabled/domjudge.conf
        state: link
      notify: restart nginx

    - name: disable default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Set PHP settings
      lineinfile:
        dest: /etc/php/7.4/fpm/pool.d/domjudge.conf
        regexp: "{{item.regexp}}"
        line: "{{item.key}} = {{item.value}}"
      with_items:
        - { key: 'pm.max_children', regexp: '^pm\.max_children', value: '{{PHP_FPM_MAX_CHILDREN}}' }
        - { key: 'pm.max_requests', regexp: '^pm\.max_requests', value: '{{PHP_FPM_MAX_REQUESTS}}' }
        - { key: 'php_admin_value[memory_limit]', regexp: '^php_admin_value\[memory_limit\]', value: '{{PHP_MEMORY_LIMIT}}' }
        - { key: 'php_admin_value[upload_max_filesize]', regexp: '^php_admin_value\[upload_max_filesize\]', value: '{{PHP_UPLOAD_MAX_FILESIZE}}' }
        - { key: 'php_admin_value[post_max_size]', regexp: '^php_admin_value\[post_max_size\]', value: '{{PHP_POST_MAX_SIZE}}' }
        - { key: 'php_admin_value[max_file_uploads]', regexp: '^php_admin_value\[max_file_uploads\]', value: '{{PHP_MAX_FILE_UPLOADS}}' }
      notify: restart PHP FPM
