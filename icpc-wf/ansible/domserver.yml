---
# This playbook installs the DOMjudge server(s)

- name: setup domserver
  hosts: domserver
  vars:
    host_type: domserver
  become: yes
  handlers:
    - include: handlers.yml
  roles:
    - role: base_packages
      tags: base_packages
    - role: ssl
      tags: ssl
      vars:
        INSTALL_SSL_PRIVATE_KEYS: true
    - role: domjudge_user
      tags: domjudge_user
    - role: domjudge_checkout
      tags: domjudge_checkout
    - role: mysql_server
      tags: mysql_server
    - role: mysql_replication
      tags: mysql_replication
    - role: keepalived
      tags: keepalived
  tasks:

    - include: common_tasks_prebuild.yml

    - name: install domserver required packages
      apt:
        state: present
        pkg:
        - nginx
        - php-fpm
        - python3-mysqldb
        - php-intl
        - macchanger
        - prometheus-nginx-exporter
        - prometheus-mysqld-exporter
        - molly-guard
        # expects config in /var/lib/prometheus/.my.cnf

    - name: set PHP timezone for FPM
      lineinfile:
        dest: /etc/php/7.4/fpm/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = {{TIMEZONE}}'

    - name: enable php modules
      command: phpenmod {{item}}
      args:
        creates: /etc/php/7.4/fpm/conf.d/20-{{item}}.ini
      with_items:
        - zip
        - intl

    - name: create collectd user for mysql status
      mysql_user:
        name: collectdstatus
        host: 'localhost'
        password: "{{COLLECTD_MYSQL_PASSWORD}}"
        append_privs: true
        priv: '*.*:PROCESS,REPLICATION CLIENT'
        state: present
      when: COLLECTD_MYSQL_PASSWORD is defined

    - name: Create MySQL authentication file
      template:
        src: files/grafana/my.cnf.j2
        dest: /var/lib/prometheus/.my.cnf
        owner: prometheus
      when: COLLECTD_MYSQL_PASSWORD is defined

    - name: Start/enable our services
      service: name={{ item }} state=started enabled=yes
      when: COLLECTD_MYSQL_PASSWORD is defined
      with_items:
       - prometheus-mysqld-exporter.service

    - include: common_tasks_build.yml

# When using replication, the DB will be dropped and recreated on the slave later.
    - name: check if the database is configured
      command: "{{DJ_DIR}}/bin/dj_setup_database -u root status"
      register: db_status
      ignore_errors: true
    - name: make sure the database is configured
      command: "{{DJ_DIR}}/bin/dj_setup_database -u root bare-install"
      when: "'failed' in db_status.stdout"

    - name: disable developer mode
      lineinfile:
        regexp: '^APP_ENV=dev'
        state: absent
        dest: "{{DJ_DIR}}/webapp/.env.local"

    - name: install contest images
      become: no
      tags: sync
      synchronize:
        src: files/domjudge-public/
        dest: "{{DJ_DIR}}/webapp/public"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - include: nginx-setup.yml

    - name: Add documentation in DOMjudge team interface
      copy: src=files/docs.yaml dest=/opt/domjudge/etc/docs.yaml

    - name: Get NGINX status
      copy: src=files/grafana/nginx-status.conf dest=/etc/nginx/sites-enabled/status.conf
      notify: restart nginx

    - name: Prometheus nginx exporter
      lineinfile:
        dest: /etc/default/prometheus-nginx-exporter
        state: present
        regexp: '^ARGS=""'
        line: 'ARGS="-nginx.scrape-uri=http://localhost:8080/basic_status"'
      notify: restart nginx-exporter

    - name: Install PHP-fpm exporter binary
      ansible.builtin.unarchive:
        src: files/grafana/php-fpm_exporter_2.0.3_linux_amd64.tar.gz
        dest: /usr/bin/
        exclude:
          - LICENSE
          - README.md

    - name: Export PHP-FPM metrics
      copy: src=files/grafana/php-fpm-exporter.service dest=/etc/systemd/system/php-fpm-exporter.service
      notify: restart php-exporter

    - name: add autostart shortcuts
      copy: src=files/{{item}}.desktop dest=/home/domjudge/.config/autostart/ owner=domjudge group=domjudge mode=0755
      with_items:
        - htop
        - taillog-domserver-nginx-error
        - taillog-domserver-symfony-error
