---

- name: setup domserver
  hosts: domserver
  become: yes
  handlers:
    - name: restart mysql
      service: name=mysql state=restarted
    - name: restart apache2
      service: name=apache2 state=restarted
    - name: restart collectd
      service: name=collectd state=restarted
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - include: common_tasks_prebuild.yml

    - name: template out the restapi secret file
      template: src=files/restapi.secret.j2 dest={{DJDIR}}/etc/restapi.secret owner=domjudge group=domjudge mode=0600

    - name: install domserver required packages
      apt: pkg={{item}} state=present
      with_items:
        - mysql-server
        - apache2
        - libapache2-mod-php

    - name: set PHP timezone
      lineinfile:
        dest: /etc/php/7.0/apache2/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = Asia/Shanghai'

    - name: enable php modules
      command: phpenmod {{item}}
      args:
        creates: /etc/php/7.0/apache2/conf.d/20-{{item}}.ini
      with_items:
        - mcrypt
        - zip

    - name: create directory for systemd mysql settings
      file: path=/etc/systemd/system/mysql.service.d/ state=directory

    - name: update systemd so mysql has bigger limits
      copy: src=files/mysql.override.cnf dest=/etc/systemd/system/mysql.service.d/override.conf
      notify: restart mysql

    - name: add mysql config snippet to increase limit
      copy: src=files/mysql.domjudge.cnf dest=/etc/mysql/mysql.conf.d/zz_domjudge.cnf
      notify: restart mysql

    - include: common_tasks_build.yml

    - name: check if the database is configured
      command: "{{DJDIR}}/bin/dj_setup_database -u root status"
      register: db_status
      ignore_errors: true
    - name: make sure the database is configured
      command: "{{DJDIR}}/bin/dj_setup_database -u root bare-install"
      when: "'failed' in db_status.stdout"

    - name: fix background color
      lineinfile:
        regexp: '^(\s*background-color):\s+white\s*;'
        line: '\1: {{BACKGROUND_COLOR}};'
        backrefs: yes
        dest: "{{DJDIR}}/webapp/web/style.css"
      when: BACKGROUND_COLOR is defined

    - name: Copy SSL public key file
      copy: src=files/2018wf-domjudge.crt dest=/etc/ssl/certs/2018wf-domjudge.crt owner=root group=root mode=0600

    - name: Copy SSL private key file
      copy: src=files/2018wf-domjudge.pem dest=/etc/ssl/private/2018wf-domjudge.pem owner=root group=root mode=0600

    - name: Update servername in apache config
      lineinfile:
        insertbefore: '^#Global config'
        line: 'Servername {{ansible_hostname}}'
        dest: /etc/apache2/apache2.conf
      notify: restart apache2
    - name: link in domjudge apache conf
      file: src={{DJDIR}}/etc/apache.conf dest=/etc/apache2/conf-available/domjudge.conf state=link
      notify: restart apache2

    - name: enable apache2 conf for domjudge
      file: src=/etc/apache2/conf-available/domjudge.conf dest=/etc/apache2/conf-enabled/domjudge.conf state=link
      notify: restart apache2

    - name: enable apache2 ssl module
      apache2_module: name=ssl state=present
      notify: restart apache2

    - name: enable apache2 rewrite module
      apache2_module: name=rewrite state=present
      notify: restart apache2

    - name: disable default apache site
      file: state=absent path=/etc/apache2/sites-enabled/000-default
      notify: restart apache2

    - name: enable default-ssl apache site
      file: src=/etc/apache2/sites-available/default-ssl.conf dest=/etc/apache2/sites-enabled/000-default-ssl state=link
      notify: restart apache2
