---

- name: setup domserver
  hosts: domserver
  vars:
    host_type: domserver
  become: yes
  handlers:
    - name: restart mysql
      service: name=mysql state=restarted
    - name: restart nginx
      service: name=nginx state=restarted
    - name: restart PHP FPM
      service: name=php7.2-fpm state=restarted
    - name: update-ca-certificates
      command: update-ca-certificates
    - name: restart collectd
      service: name=collectd state=restarted
    - name: restart rsyslog
      service: name=rsyslog enabled=yes state=restarted
    - name: restart systemctl
      shell: systemctl daemon-reload
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - include: common_tasks_prebuild.yml

    - name: install domserver required packages
      apt: pkg={{item}} state=present
      with_items:
        - mysql-server
        - nginx
        - php-fpm
        - python-mysqldb
        - php-intl

    - name: set PHP timezone for FPM
      lineinfile:
        dest: /etc/php/7.2/fpm/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = {{TIMEZONE}}'

    - name: set PHP timezone for CLI
      lineinfile:
        dest: /etc/php/7.2/cli/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = {{TIMEZONE}}'

    - name: enable php modules
      command: phpenmod {{item}}
      args:
        creates: /etc/php/7.2/fpm/conf.d/20-{{item}}.ini
      with_items:
        - zip
        - intl

    - name: create directory for systemd mysql settings
      file: path=/etc/systemd/system/mysql.service.d/ state=directory

    - name: update systemd so mysql has bigger limits
      copy: src=files/mysql.override.cnf dest=/etc/systemd/system/mysql.service.d/override.conf
      notify: restart mysql

    - name: add mysql config snippet to increase limit
      copy: src=files/mysql.domjudge.cnf dest=/etc/mysql/conf.d/zz_domjudge.cnf
      notify: restart mysql

    - name: add mysql config snippet for replication
      template: src=files/mysql.replication.cnf.j2 dest=/etc/mysql/conf.d/zzz_replication.cnf
      notify: restart mysql
      when: REPLICATION_PASSWORD is defined

    - name: make sure mysql is restarted
      meta: flush_handlers

    - name: copy mysql setup script for replication
      template: src=files/setup-replication.sql.j2 dest=/tmp/setup-replication.sql
      when: REPLICATION_PASSWORD is defined

    - name: create mysql replication user
      mysql_user:
        name: replication
        host: '%'
        password: "{{REPLICATION_PASSWORD}}"
        append_privs: true
        priv: '*.*:REPLICATION SLAVE'
        state: present
      when: REPLICATION_PASSWORD is defined

    - name: create collectd user for mysql status
      mysql_user:
        name: collectdstatus
        host: 'localhost'
        password: "{{COLLECTD_MYSQL_PASSWORD}}"
        append_privs: true
        priv: '*.*:PROCESS/*.*:REPLICATION CLIENT'
        state: present
      when: COLLECTD_MYSQL_PASSWORD is defined

    - include: common_tasks_build.yml

# TODO: find a way to run this correctly when having a master-master setup that doesn't use localhost in the dbpasswords.secret file
#    - name: check if the database is configured
#      command: "{{DJ_DIR}}/bin/dj_setup_database -u root status"
#      register: db_status
#      ignore_errors: true
#    - name: make sure the database is configured
#      command: "{{DJ_DIR}}/bin/dj_setup_database -u root bare-install"
#      when: "'failed' in db_status.stdout"

    - name: fix background color
      lineinfile:
        regexp: '^(\s*background-color):\s+white\s*;'
        line: '\1: {{BACKGROUND_COLOR}};'
        backrefs: yes
        dest: "{{DJ_DIR}}/webapp/web/style.css"
      when: BACKGROUND_COLOR is defined

    - name: copy in domjudge FPM conf
      copy: src={{DJ_DIR}}/etc/domjudge-fpm.conf remote_src=yes dest=/etc/php/7.2/fpm/pool.d/domjudge.conf
      notify: restart PHP FPM

    - name: copy in domjudge nginx conf
      copy: src={{DJ_DIR}}/etc/nginx-conf remote_src=yes dest=/etc/nginx/sites-available/domjudge-systest
      notify: restart nginx

    - name: remove HTTP host
      blockinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        marker: "{mark}"
        marker_begin: "### http host config ###"
        marker_end: "# Alternatively, use HTTPS and redirect HTTP to HTTPS:"
      notify: restart nginx

    - name: enable HTTP redirect and HTTPS blocks
      replace:
        path: /etc/nginx/sites-available/domjudge-systest
        after: 'upstream domjudge \{'
        regexp: '^# ?(.*)'
        replace: '\1'
      notify: restart nginx

    - name: remove HTTP redirect host
      blockinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        marker: "{mark}"
        marker_begin: 	listen   80;"
        marker_end: "server {"
      notify: restart nginx

    - name: Set system test hostname
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'server_name'
        line: "\tserver_name systest.domjudge.org;"
      notify: restart nginx

    - name: remove IPv6 listens
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'listen\s+\[.*\]:\d+;'
        state: absent
      notify: restart nginx

    - name: change IPv4 HTTP listen to default server
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'listen.*80;'
        line: "\tlisten 80 default_server;"
      notify: restart nginx

    - name: change IPv4 HTTPS listen to all interfaces
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'listen.*443;'
        line: "\tlisten 443 ssl http2 default_server;"
      notify: restart nginx

    - name: increase max body size to upload size
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'client_max_body_size'
        line: "\tclient_max_body_size {{PHP_UPLOAD_MAX_FILESIZE}};"
      notify: restart nginx

    - name: remove prefixed domjudge location
      blockinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        marker: "{mark}"
        marker_begin: "	# Or you can install it with a prefix"
        marker_end: "	}"
      notify: restart nginx

    - name: configure SSL certificate
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'ssl_certificate (.*)'
        line: "\tssl_certificate {{DOMSERVER_SSL_CERT}};"
      notify: restart nginx

    - name: configure SSL key
      lineinfile:
        path: /etc/nginx/sites-available/domjudge-systest
        regexp: 'ssl_certificate_key (.*)'
        line: "\tssl_certificate_key {{DOMSERVER_SSL_KEY}};"
      notify: restart nginx

    - name: enable nginx conf for domjudge
      file: src=/etc/nginx/sites-available/domjudge-systest dest=/etc/nginx/sites-enabled/domjudge-systest state=link
      notify: restart nginx

    - name: disable default nginx site
      file: state=absent path=/etc/nginx/sites-enabled/default
      notify: restart nginx

    - name: Increase PM max children for PHP FPM
      lineinfile:
        dest: /etc/php/7.2/fpm/pool.d/domjudge.conf
        regexp: '^pm\.max_children'
        line: 'pm.max_children = 300'
      with_items:
        - { key: 'pm.max_children', regexp: '^pm\.max_children', value: '{{PHP_FPM_MAX_CHILDREN}}' }
        - { key: 'php_admin_value[memory_limit]', regexp: '^php_admin_value\[memory_limit\]', value: '{{PHP_MEMORY_LIMIT}}' }
        - { key: 'php_admin_value[upload_max_filesize]', regexp: '^php_admin_value\[upload_max_filesize\]', value: '{{PHP_UPLOAD_MAX_FILESIZE}}' }
        - { key: 'php_admin_value[post_max_size]', regexp: '^php_admin_value\[post_max_size\]', value: '{{PHP_POST_MAX_SIZE}}' }
      notify: restart PHP FPM
