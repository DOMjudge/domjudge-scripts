---

- name: setup domserver
  hosts: domserver
  become: yes
  handlers:
    - name: restart mysql
      service: name=mysql state=restarted
    - name: restart apache2
      service: name=apache2 state=restarted
    - name: restart collectd
      service: name=collectd state=restarted
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - include: common_tasks_prebuild.yml

    - name: template out the restapi secret file
      template: src=files/restapi.secret-domserver.j2 dest={{DJDIR}}/etc/restapi.secret owner=domjudge group=domjudge mode=0600

    - name: install domserver required packages
      apt: pkg={{item}} state=present
      with_items:
        - mysql-server
        - apache2
        - libapache2-mod-php
        - python-mysqldb
        - php-intl

    - name: set PHP timezone
      lineinfile:
        dest: /etc/php/7.0/apache2/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = {{TIMEZONE}}'

    - name: enable php modules
      command: phpenmod {{item}}
      args:
        creates: /etc/php/7.0/apache2/conf.d/20-{{item}}.ini
      with_items:
        - mcrypt
        - zip
        - intl

    - name: create directory for systemd mysql settings
      file: path=/etc/systemd/system/mysql.service.d/ state=directory

    - name: update systemd so mysql has bigger limits
      copy: src=files/mysql.override.cnf dest=/etc/systemd/system/mysql.service.d/override.conf
      notify: restart mysql

    - name: add mysql config snippet to increase limit
      copy: src=files/mysql.domjudge.cnf dest=/etc/mysql/mysql.conf.d/zz_domjudge.cnf
      notify: restart mysql

    - name: add mysql config snippet for replication
      template: src=files/mysql.replication.cnf.j2 dest=/etc/mysql/mysql.conf.d/zzz_replication.cnf
      notify: restart mysql

    - name: make sure mysql is restarted
      meta: flush_handlers

    - name: copy mysql setup script for replication
      template: src=files/setup-replication.sql.j2 dest=/tmp/setup-replication.sql

    - name: create mysql replication user
      mysql_user:
        name: replication
        host: '%'
        password: "{{REPLICATION_PASSWORD}}"
        append_privs: true
        priv: '*.*:REPLICATION SLAVE'
        state: present

    - name: create collectd user for mysql status
      mysql_user:
        name: collectdstatus
        host: 'localhost'
        password: "{{COLLECTD_MYSQL_PASSWORD}}"
        append_privs: true
        priv: '*.*:PROCESS/*.*:REPLICATION CLIENT'
        state: present

    - include: common_tasks_build.yml

# TODO: find a way to run this correctly when having a master-master setup that doesn't use localhost in the dbpasswords.secret file
#    - name: check if the database is configured
#      command: "{{DJDIR}}/bin/dj_setup_database -u root status"
#      register: db_status
#      ignore_errors: true
#    - name: make sure the database is configured
#      command: "{{DJDIR}}/bin/dj_setup_database -u root bare-install"
#      when: "'failed' in db_status.stdout"

    - name: fix background color
      lineinfile:
        regexp: '^(\s*background-color):\s+white\s*;'
        line: '\1: {{BACKGROUND_COLOR}};'
        backrefs: yes
        dest: "{{DJDIR}}/webapp/web/style.css"
      when: BACKGROUND_COLOR is defined

    - name: Copy SSL public key file
      copy: src=files/2018wf-domjudge.crt dest=/etc/ssl/certs/2018wf-domjudge.crt owner=root group=root mode=0600

    - name: Copy SSL private key file
      copy: src=files/2018wf-domjudge.pem dest=/etc/ssl/private/2018wf-domjudge.pem owner=root group=root mode=0600

    - name: Update servername in apache config
      lineinfile:
        insertbefore: '^#Global config'
        line: 'Servername {{ansible_hostname}}'
        dest: /etc/apache2/apache2.conf
      notify: restart apache2

    - name: link in domjudge apache conf
      file: src={{DJDIR}}/etc/apache.conf dest=/etc/apache2/conf-available/domjudge.conf state=link
      notify: restart apache2

    - name: enable apache2 conf for domjudge
      file: src=/etc/apache2/conf-available/domjudge.conf dest=/etc/apache2/conf-enabled/domjudge.conf state=link
      notify: restart apache2

    - name: enable apache2 modules
      apache2_module: name={{item}} state=present
      with_items:
        - ssl
        - rewrite
      notify: restart apache2

    - name: disable default apache site
      file: state=absent path=/etc/apache2/sites-enabled/000-default
      notify: restart apache2

    - name: enable default-ssl apache site
      file: src=/etc/apache2/sites-available/default-ssl.conf dest=/etc/apache2/sites-enabled/000-default-ssl state=link
      notify: restart apache2

    - name: disable apache keepalive
      replace:
        dest: /etc/apache2/apache2.conf
        regexp: 'KeepAlive\s+On'
        replace: 'KeepAlive Off'
      notify: restart apache2

    - name: change NPM prefork MinSpareServers
      replace:
        dest: /etc/apache2/mods-enabled/mpm_prefork.conf
        regexp: '^[^#].*MinSpareServers.*$'
        replace: '\tMinSpareServers   50'
      notify: restart apache2

    - name: change NPM prefork MaxSpareServers
      replace:
        dest: /etc/apache2/mods-enabled/mpm_prefork.conf
        regexp: '^[^#].*MaxSpareServers.*$'
        replace: '\tMaxSpareServers   100'
      notify: restart apache2

    - name: change NPM prefork MaxRequestWorkers
      replace:
        dest: /etc/apache2/mods-enabled/mpm_prefork.conf
        regexp: '^[^#].*MaxRequestWorkers.*$'
        replace: '\tMaxRequestWorkers 500'
      notify: restart apache2

    - name: add NPM prefork ServerLimit
      lineinfile:
        dest: /etc/apache2/mods-enabled/mpm_prefork.conf
        regexp: 'ServerLimit'
        line: '	ServerLimit       500'
        insertbefore: '/IfModule'
      notify: restart apache2

    - name: autologin domjudge user
      copy: src=files/lightdm-domjudge.conf dest=/etc/lightdm/lightdm.conf.d/domjudge.conf

    - name: make sure autostart directory exists
      file: dest=/home/domjudge/.config/autostart state=directory owner=domjudge group=domjudge
      tags: fix_autostart

    - name: add autostart shortcuts
      copy: src=files/{{item}}.desktop dest=/home/domjudge/.config/autostart/ owner=domjudge group=domjudge mode=0755
      with_items:
        - htop
        - taillog-domserver-apache-error
        - taillog-domserver-symfony-error
        - domjudgelogo-domserver

