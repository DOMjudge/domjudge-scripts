---

- name: update judgehost code
  hosts: judgehost
  vars:
    host_type: judgehost
  become: yes
  roles:
    - role: domjudge_checkout
      tags: domjudge_checkout
  tasks:

    - name: disable clearing Symfony cache when building
      lineinfile:
        dest: "{{DJ_DIR}}/Makefile"
        regexp: "^(.*-C webapp clear-cache)$"
        line: '#\1'
        backrefs: yes

    - name: run maintainer-conf
      become: yes
      become_user: domjudge
      command: make maintainer-conf CONFIGURE_FLAGS='--disable-doc-build'
      register: dj_configured
      args:
        chdir: "{{DJ_DIR}}"
        creates: "{{DJ_DIR}}/paths.mk"

    - name: check if domjudge is built
      stat: path="{{DJ_DIR}}/judge/judgedaemon"
      register: judgedaemon_binary

    - name: build domjudge
      become: yes
      become_user: domjudge
      shell: make maintainer-install chdir={{DJ_DIR}}
      when: git_working_copy.changed or dj_configured.changed or not judgedaemon_binary.stat.exists

    - name: fix permissions on things
      shell: make -C {{DJ_DIR}} maintainer-postinstall-permissions

    - name: re-enable clearing Symfony cache when building
      lineinfile:
        dest: "{{DJ_DIR}}/Makefile"
        regexp: "^#(.*-C webapp clear-cache)$"
        line: '\1'
        backrefs: yes

    - name: enable and restart the services we just copied
      service: name={{item}} enabled=yes state=restarted
      with_items:
        - domjudge-judgehost
