- name: setup admin machines
  hosts: admin
  vars:
    host_type: admin
  become: yes
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - name: set timezone
      timezone:
        name: "{{TIMEZONE}}"

    - include: common_tasks_packages_icpc-wf.yml

    - name: install common required/useful packages
      tags: packages
      apt: pkg={{item}} state=present
      with_items:
        - htop
        - clusterssh
        - git
        - screen

    - name: configure git as domjudge user
      ini_file:
        dest: /home/domjudge/.gitconfig
        section: user
        option: "{{item.name}}"
        value: "{{item.value}}"
        owner: domjudge
        group: domjudge
      with_items:
        - { name: 'email', value: 'team@domjudge.org' }
        - { name: 'name', value: 'DOMjudge team' }

    - name: Create .ssh directory
      file: path="/home/domjudge/.ssh" group=domjudge owner=domjudge mode=0700 state=directory

    - name: Copy SSH key for git access
      copy:
        content: "{{DJ_GIT_SSH_KEY}}"
        dest: /home/domjudge/.ssh/dj_git_ssh_key
        owner: domjudge
        group: domjudge
        mode: 0600
      when: DJ_GIT_SSH_KEY is defined

    - name: Create SSH config
      template: src=files/ssh-config-domjudge.j2 dest=/home/domjudge/.ssh/config owner=domjudge group=domjudge mode=0600
      when: DJ_GIT_HOST is defined

    - name: create working copy from the repo
      become: yes
      become_user: domjudge
      # We use a different directory here to have one single 'upstream' and not have issues with it
      git: repo={{DJ_GIT_REPO}} dest=/home/domjudge/domjudge-checkout version={{DJ_BRANCH}} accept_hostkey=yes update=yes
      register: git_working_copy