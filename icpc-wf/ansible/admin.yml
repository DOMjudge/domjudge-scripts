- name: setup admin machines
  hosts: admin
  vars:
    host_type: admin
  become: yes
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - include: common_tasks_all.yml

    - name: fix root ssh key permissions
      file:
        path: /root/.ssh/id_ed25519
        mode: 0600
        owner: root
        group: root
    
    - name: install common required/useful packages
      tags: packages
      apt: pkg={{item}} state=present
      with_items:
        - htop
        - clusterssh
        - makepasswd
        - tig
        - httpie

    - name: create working copy from the repo
      become: yes
      become_user: domjudge
      # We use a different directory here to have one single 'upstream' and not have issues with it
      git: repo={{DJ_GIT_REPO}} dest=/home/domjudge/domjudge-checkout version={{DJ_BRANCH}} accept_hostkey=yes update=yes
      register: git_working_copy

    - name: create working copy from the domjudge-scripts repo
      become: yes
      become_user: domjudge
      # We use a different directory here to have one single 'upstream' and not have issues with it
      git: repo=domjudge@10.3.3.223:domjudge-scripts dest=/home/domjudge/domjudge-scripts-checkout version=master accept_hostkey=yes update=yes
      register: git_working_copy

    - name: Check composer dependencies present
      local_action: stat path=files/lib/vendor
      register: libvendor
      become: no

    - name: Copy in composer dependencies (if they exist locally)
      tags: sync
      synchronize:
        src: files/lib/vendor/
        dest: "/home/domjudge/domjudge-checkout/lib/vendor/"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync
      when: libvendor.stat.exists

    - name: fix ownership of lib/vendor
      file:
        path: "/home/domjudge/domjudge-checkout/lib/vendor"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: create clusterssh config file
      file:
        path: /etc/clusters
        state: touch
        owner: root
        group: root
        mode: 0644

    - name: create clusterssh 'all' config group
      lineinfile:
        dest: /etc/clusters
        regexp: '^all'
        line: "all {{ groups['all'] | join(' ') }}"

    - name: create clusterssh config groups
      lineinfile:
        dest: /etc/clusters
        regexp: '^{{ item }}s'
        line: "{{item}}s {{ groups[item] | join(' ') }}"
      with_items:
        - domserver
        - judgehost
        - admin

    - name: Copy in PHPStorm
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/PhpStorm-191.6183.95
        dest: "/phpstorm"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync
    
    - name: Create PHPStorm stuff directory
      file: path="/home/domjudge/phpstorm-stuff" group=domjudge owner=domjudge mode=0700 state=directory
      
    - name: Copy in PHPStorm stuff
      become: yes
      become_user: domjudge
      copy:
        src: files/phpstorm/{{ item }}
        dest: /home/domjudge/phpstorm-stuff/{{ item }}
      with_items:
        - BIGNM3NHDL.txt
        - PHP_Annotations-5.3.3.zip
        - php-toolbox.jar
        - Symfony_Plugin-0.17.172.zip
