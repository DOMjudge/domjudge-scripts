- name: setup admin machines
  hosts: admin
  vars:
    host_type: admin
  become: yes
  handlers:
    - include: handlers.yml
  tasks:
    - name: include global variables
      include_vars: variables.yml
    - name: include global (secret) variables
      include_vars: variables-secret.yml
    - name: override global variables
      include_vars: variables_admin.yml

    - include: common_tasks_all.yml

    - name: Allow 'sudo' group to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%sudo'
        line: '%sudo ALL=(ALL) NOPASSWD: ALL'

    - name: create working copy of the repo
      become: yes
      become_user: domjudge
      git: repo={{DJ_GIT_REPO}} dest=/home/domjudge/domjudge-checkout version={{DJ_BRANCH}} accept_hostkey=yes update=no
      register: git_working_copy

    - name: Check composer dependencies present
      local_action: stat path=files/lib/vendor
      register: libvendor
      become: no

    - name: Copy in composer dependencies (if they exist locally)
      become: no
      tags: sync
      synchronize:
        src: files/lib/vendor/
        dest: "/home/domjudge/domjudge-checkout/lib/vendor/"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync
      when: libvendor.stat.exists

    - name: fix ownership of lib/vendor
      file:
        path: "/home/domjudge/domjudge-checkout/lib/vendor"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: install common required/useful packages
      tags: packages
      apt:
        state: present
        pkg:
        - clusterssh
        - gitk
        - git-gui
        - makepasswd
        - mariadb-server
        - nginx
        - php-fpm
        - python3-mysqldb
        - php-intl
        - mycli
        - mmv

    - name: copy in MySQL config
      copy: src=files/my.cnf dest=/root/.my.cnf

    - name: set PHP timezone for FPM
      lineinfile:
        dest: /etc/php/7.4/fpm/php.ini
        state: present
        regexp: 'date\.timezone\s*='
        line: 'date.timezone = {{TIMEZONE}}'

    - name: enable php modules
      command: phpenmod {{item}}
      args:
        creates: /etc/php/7.4/fpm/conf.d/20-{{item}}.ini
      with_items:
        - zip
        - intl

    - name: create directory for systemd mysql settings
      file: path=/etc/systemd/system/mysql.service.d/ state=directory

    - name: update systemd so mysql has bigger limits
      copy: src=files/mysql.override.cnf dest=/etc/systemd/system/mysql.service.d/override.conf
      notify: restart mysql

    - name: add mysql config snippet to increase limit
      copy: src=files/mysql.domjudge.cnf dest=/etc/mysql/mariadb.conf.d/zz_domjudge.cnf
      notify: restart mysql

    - name: make sure mysql is restarted
      meta: flush_handlers

    - include: common_tasks_build.yml
      vars:
        DJ_DIR: /home/domjudge/domjudge-checkout

    - name: check if the database is configured
      command: "/home/domjudge/domjudge-checkout/bin/dj_setup_database -u root status"
      register: db_status
      ignore_errors: true

    - name: make sure the database is configured
      command: "/home/domjudge/domjudge-checkout/bin/dj_setup_database -u root bare-install"
      when: "'failed' in db_status.stdout"

    - name: install SSL server certificates
      copy:
        src: "{{ item }}"
        dest: /etc/ssl/certs/
        owner: root
        group: root
        mode: 0644
      with_fileglob:
        - files/ssl/*.crt
      notify: update-ca-certificates

    - name: trust localhost SSL certificate
      copy:
        src: ssl/localhost.crt
        dest: /usr/local/share/ca-certificates/
        owner: root
        group: root
        mode: 0644
      notify: update-ca-certificates

    - include: nginx-setup.yml
      vars:
        DJ_DIR: /home/domjudge/domjudge-checkout
        DOMSERVER_SSL_CERT: /etc/ssl/certs/localhost.crt
        DOMSERVER_SSL_KEY: /etc/ssl/private/localhost.key

    - name: Use Symfony dev-mode
      lineinfile:
        path: /etc/nginx/snippets/domjudge-inner
        regexp: 'frontController .*;'
        line: "set $frontController app_dev.php;"
      notify: restart nginx

    - name: create domjudge-run users
      user: name={{item}} createhome=no home=/nonexistent group=nogroup shell=/bin/false
      with_items:
        - domjudge-run-0
    - name: create domjudge-run group
      group: name=domjudge-run state=present

    - name: template out the restapi secret file
      template: src=files/restapi.secret.admin.j2 dest=/home/domjudge/domjudge-checkout/etc/restapi.secret owner=domjudge group=domjudge mode=0600

    - name: add cds to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'cds$'
        line: "10.3.3.207	cds"

    - name: add kattis to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'kattis$'
        line: "10.3.3.212	kattis"

    - name: add domjudge-laptop to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'domjudge-laptop$'
        line: "10.3.3.200	domjudge-laptop"

    - name: add nisprint to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'printsrv$'
        line: "10.3.3.211	nisprint nismaster printsrv"

    - name: remove apt-transport-https from bionic debootstrap file
      lineinfile:
        path: /usr/share/debootstrap/scripts/bionic
        regexp: 'ca-certificates'
        line: '                base="$base ca-certificates"'

    - name: copy chroot DEB packages to install
      copy: src=files/install-chroot dest=/tmp/dj_ansible/

    - name: create chroot
      shell: "/home/domjudge/domjudge-checkout/misc-tools/dj_make_chroot -y -i openjdk-11-jdk-headless -l \"$(ls /tmp/dj_ansible/install-chroot/*.deb 2>/dev/null | tr '\n' ',')\" 2>&1 | tee /tmp/dj_make_chroot.log"
      environment:
        DEBMIRROR: https://packages/ubuntu
      args:
        creates: "/chroot/domjudge"

    - name: fix kernel parameters
      lineinfile:
        dest: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash cgroup_enable=memory swapaccount=1"'
      register: kernel_params

    - name: update grub
      shell: "update-grub"
      when: kernel_params.changed

    - name: copy script to disable turboboost and hyperthreading
      copy: src=files/disable-turboboost_ht dest=/usr/local/sbin/ mode=0755

    - name: copy systemd unit files
      copy: src=files/{{item}}.service dest=/etc/systemd/system/
      tags: updateservice
      with_items:
        - create_cgroups_admin
      notify: restart systemctl

    - name: make sure systemctl is restarted
      meta: flush_handlers

    - name: enable and restart the services we just copied
      service: name={{item}} enabled=yes state=restarted
      with_items:
        - create_cgroups_admin

    - name: disable systemd timers
      command: systemctl mask {{item}}
      args:
        creates: /etc/systemd/system/{{item}}
      with_items:
        - apt-daily-upgrade.timer
        - apt-daily.timer
        - systemd-tmpfiles-clean.timer

    - name: create working copy of the domjudge-scripts repo
      become: yes
      become_user: domjudge
      # We use a different directory here to have one single 'upstream' and not have issues with it
      git: repo=domjudge@10.3.3.223:domjudge-scripts-bare dest=/home/domjudge/domjudge-scripts-checkout version=main accept_hostkey=yes update=no

    - name: create working copy of the wf2020 repo
      become: yes
      become_user: domjudge
      git: repo=git@cds:wf2020 dest=/home/domjudge/wf2020 version=master accept_hostkey=yes update=no

    - name: copy custom CSS file for admin machines
      copy:
        src: admin-machine.css
        dest: "/home/domjudge/domjudge-checkout/webapp/public/css/custom/admin-machine.css"
        owner: domjudge
        group: domjudge
        mode: 0644
      register: css_installed

    - name: Clear application cache
      command: /home/domjudge/domjudge-checkout/webapp/bin/console cache:clear
      become: yes
      become_user: domjudge
      when: css_installed.changed

    - name: create clusterssh config file
      file:
        path: /etc/clusters
        state: touch
        owner: root
        group: root
        mode: 0644

    - name: create clusterssh 'all' config group
      lineinfile:
        dest: /home/domjudge/.clusterssh/clusters
        regexp: '^all'
        line: "all {{ groups['all'] | join(' ') }}"
        create: yes

    - name: create clusterssh config groups
      lineinfile:
        dest: /home/domjudge/.clusterssh/clusters
        regexp: '^{{ item }}s'
        line: "{{item}}s {{ groups[item] | join(' ') }}"
        create: yes
      with_items:
        - domserver
        - judgehost
        - admin

    - name: Copy in PHPStorm
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/PhpStorm-{{ PHPSTORM_FULL_VERSION }}
        dest: "/phpstorm"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: Copy in PHPStorm config
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/PhpStorm{{ PHPSTORM_VERSION }}
        dest: "/home/domjudge/.config/JetBrains"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: Copy in PHPStorm jdbc drivers
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/jdbc-drivers
        dest: "/home/domjudge/.config/JetBrains/PhpStorm{{ PHPSTORM_VERSION }}/"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: fix ownership of PHPStorm config
      file:
        path: "/home/domjudge/.config/JetBrains/PhpStorm{{ PHPSTORM_VERSION }}"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: Create local directory
      become: yes
      become_user: domjudge
      file:
        path: "/home/domjudge/.local/share/JetBrains/"
        state: directory
        mode: '0755'

    - name: Copy in PHPStorm local share
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/PhpStorm{{ PHPSTORM_VERSION }}-local-share/
        dest: "/home/domjudge/.local/share/JetBrains/PhpStorm{{ PHPSTORM_VERSION }}"
        owner: no
        recursive: yes
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: fix ownership of PHPStorm local share
      file:
        path: "/home/domjudge/.local/share/JetBrains/PhpStorm{{ PHPSTORM_VERSION }}"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: Copy in PHPStorm settings for repo
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/.idea
        dest: "/home/domjudge/domjudge-checkout"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: fix ownership of PHPStorm config
      file:
        path: "/home/domjudge/domjudge-checkout/.idea"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: Create a directory if it does not exist
      become: yes
      become_user: domjudge
      file:
        path: /home/domjudge/.local/share/applications
        state: directory
        mode: '0755'

    - name: Copy in PHPStorm Desktop icon
      become: yes
      become_user: domjudge
      template:
        src: files/jetbrains-phpstorm.desktop.j2
        dest: /home/domjudge/.local/share/applications/jetbrains-phpstorm.desktop

    - name: Install netrc file
      template: src=files/netrc.j2 dest=/home/domjudge/.netrc owner=domjudge group=domjudge mode=0600
