- name: setup admin machines
  hosts: admin
  vars:
    host_type: admin
  become: yes
  tasks:
    - name: include global variables
      include_vars: variables.yml

    - include: common_tasks_all.yml

    - name: fix root ssh key permissions
      file:
        path: /root/.ssh/id_ed25519
        mode: 0600
        owner: root
        group: root
    
    - name: install common required/useful packages
      tags: packages
      apt: pkg={{item}} state=present
      with_items:
        - clusterssh
        - gitk
        - git-gui
        - makepasswd
        - tig
    - name: add cds to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'cds$'
        line: "10.3.3.207	cds"
    - name: add kattis to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'kattis$'
        line: "10.3.3.212	kattis"
    - name: add domjudge-laptop to hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: 'domjudge-laptop$'
        line: "10.3.3.200	domjudge-laptop"

   - name: create working copy from the repo
     become: yes
     become_user: domjudge
     # We use a different directory here to have one single 'upstream' and not have issues with it
     git: repo={{DJ_GIT_REPO}} dest=/home/domjudge/domjudge-checkout version={{DJ_BRANCH}} accept_hostkey=yes update=yes
     register: git_working_copy

   - name: create working copy from the domjudge-scripts repo
     become: yes
     become_user: domjudge
     # We use a different directory here to have one single 'upstream' and not have issues with it
     git: repo=domjudge@10.3.3.223:domjudge-scripts dest=/home/domjudge/domjudge-scripts-checkout version=master accept_hostkey=yes update=yes

   - name: add cds to hosts file
     lineinfile:
       dest: /etc/hosts
       regexp: 'cds$'
       line: "10.3.3.207	cds"

   - name: create working copy from the wf2019 repo
     become: yes
     become_user: domjudge
     git: repo=git@cds:wf2019 dest=/home/domjudge/wf2019 version=master accept_hostkey=yes update=yes

    - name: Check composer dependencies present
      local_action: stat path=files/lib/vendor
      register: libvendor
      become: no

    - name: Copy in composer dependencies (if they exist locally)
      tags: sync
      synchronize:
        src: files/lib/vendor/
        dest: "/home/domjudge/domjudge-checkout/lib/vendor/"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync
      when: libvendor.stat.exists

    - name: fix ownership of lib/vendor
      file:
        path: "/home/domjudge/domjudge-checkout/lib/vendor"
        recurse: yes
        owner: domjudge
        group: domjudge

    - name: create clusterssh config file
      file:
        path: /etc/clusters
        state: touch
        owner: root
        group: root
        mode: 0644

    - name: create clusterssh 'all' config group
      lineinfile:
        dest: /etc/clusters
        regexp: '^all'
        line: "all {{ groups['all'] | join(' ') }}"

    - name: create clusterssh config groups
      lineinfile:
        dest: /etc/clusters
        regexp: '^{{ item }}s'
        line: "{{item}}s {{ groups[item] | join(' ') }}"
      with_items:
        - domserver
        - judgehost
        - admin

    - name: Copy in PHPStorm
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/PhpStorm-191.6183.95
        dest: "/phpstorm"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: Copy in PHPStorm config
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/.PhpStorm2019.1
        dest: "/home/domjudge"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: fix ownership of PHPStorm config
      file:
        path: "/home/domjudge/.PhpStorm2019.1"
        recurse: yes
        owner: domjudge
        group: domjudge
    
    - name: Create PHPStorm stuff directory
      file: path="/home/domjudge/phpstorm-stuff" group=domjudge owner=domjudge mode=0700 state=directory

    - name: Copy in PHPStorm settings for repo
      become: no
      tags: sync
      synchronize:
        src: files/phpstorm/.idea
        dest: "/home/domjudge/domjudge-checkout"
        owner: no
        use_ssh_args: true
        rsync_path: sudo rsync

    - name: fix ownership of PHPStorm config
      file:
        path: "/home/domjudge/domjudge-checkout/.idea"
        recurse: yes
        owner: domjudge
        group: domjudge
    
    - name: Create PHPStorm stuff directory
      file: path="/home/domjudge/phpstorm-stuff" group=domjudge owner=domjudge mode=0700 state=directory
      
    - name: Copy in PHPStorm stuff
      become: yes
      become_user: domjudge
      copy:
        src: files/phpstorm/{{ item }}
        dest: /home/domjudge/phpstorm-stuff/{{ item }}
      with_items:
        - BIGNM3NHDL.txt
        - PHP_Annotations-5.3.3.zip
        - php-toolbox.jar
        - Symfony_Plugin-0.17.172.zip
        - mysql-connector-java-8.0.13.jar
      
    - name: Copy in PHPStorm Desktop icon
      become: yes
      become_user: domjudge
      copy:
        src: files/phpstorm/jetbrains-phpstorm.desktop
        dest: /home/domjudge/.local/share/applications/jetbrains-phpstorm.desktop

    - name: Install netrc file
      template: src=files/netrc.j2 dest=/home/domjudge/.netrc owner=domjudge group=domjudge mode=0600
