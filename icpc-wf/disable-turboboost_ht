#!/bin/bash -e

# set governor to performance
for i in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
	echo performance > $i
done

# do not allow changes later on
chmod -w /sys/devices/system/cpu/cpu?/cpufreq/scaling_governor

# disable all but on thread on each core
declare -A core_ids
for i in /sys/devices/system/cpu/cpu?/topology/core_id; do
	core_id=$(cat $i)
	if [[ ${core_ids[$core_id]} ]]; then
		echo 0 > $(dirname $i)/../online
	else
		core_ids[$core_id]=1
	fi
done

# now disable turbo boost
echo -n 1 > /sys/devices/system/cpu/intel_pstate/no_turbo

# increase freq from powersaving to normal, but don't overclock
echo 100 > /sys/devices/system/cpu/intel_pstate/min_perf_pct
echo 100 > /sys/devices/system/cpu/intel_pstate/max_perf_pct
